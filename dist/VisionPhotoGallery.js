!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.VisionPhotoGallery=e():t.VisionPhotoGallery=e()}(this,(function(){return function(){"use strict";var t={946:function(t,e,o){function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function i(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}o.d(e,{default:function(){return a}});var a=function(){function t(e){var o=e.root,n=e.employeeId,r=e.token,i=e.disableControls,a=void 0!==i&&i;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),!o)throw new Error("Не указан ID корневого элемента для галереи!");var u=document.getElementById(o);if(!u)throw new Error("Проверьте указанный ID корневого элемента для галереи!");if(this.constructor.rootElement=u,!n)throw new Error("Не указан ID пользователя на портале Vision");this.employeeId=n,this.token=r,this.disableControls=a,this.constructor.draw()}var e,o,i;return e=t,i=[{key:"update",value:function(t){var e=t.employeeId,o=t.token;this.employeeId=e,this.token=o,this.draw()}},{key:"handleError",value:function(t){var e=t.message,o=t.blockingErrorMessage;if(this.errorFunction){var r="";"object"===n(e)&&Object.keys(e).reverse().forEach((function(t){r+="".concat(e[t],"<br/>")}));var i=r.length?r:JSON.stringify(e);this.errorFunction(i,"Ошибка")}else{if(o)throw new Error(o);console.log(e)}}},{key:"request",value:function(t){var e=t.requestPath,o=t.requestBody,n={method:"POST",mode:"same-origin",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this.token},body:JSON.stringify(o)};return fetch("/api/v2/vision/".concat(e,"/"),n)}},{key:"getPhotos",value:function(){return this.request({requestPath:"get_photos",requestBody:{employeeId:this.employeeId,masterAlbum:!0}})}},{key:"addPhoto",value:function(t){return this.request({requestPath:"add_photo",requestBody:{employeeId:this.employeeId,image:t}})}},{key:"deletePhoto",value:function(t){return this.request({requestPath:"delete_photo",requestBody:{employeeId:this.employeeId,photoIds:[t],masterAlbum:!0}})}},{key:"updatePhoto",value:function(t){return this.request({requestPath:"update_photo",requestBody:{employeeId:this.employeeId,photo_id:t}})}},{key:"draw",value:function(){var t=this,e=this.rootElement;e.innerHTML='\n            <div class="vision-photo-gallery">\n                <input type="file" class="vision-photo-gallery__file-field" tabindex="-1">\n                <div class="vision-photo-gallery__item vision-photo-gallery__item--main">\n                    <h4 class="vision-photo-gallery__title">Основная фотография</h4>\n                    <div class="vg-main-photo"></div>\n                </div>\n                <div class="vision-photo-gallery__item">\n                    <h4 class="vision-photo-gallery__title">Галерея</h4>\n                    <div class="vg-gallery"></div>\n                </div>\n            </div>\n        ';var o=e.querySelector(".vg-main-photo"),n=e.querySelector(".vg-gallery");this.getPhotos().then((function(e){if(o.innerHTML=t.createPhotoElement({main:!0,empty:!0,photoId:null}),n.innerHTML=t.createPhotoElement({main:!1,empty:!0,photoId:null}),e.ok)return e.json();o.innerHTML=t.createPhotoElement({main:!0,empty:!0,photoId:null}),t.initEvents()})).then((function(e){if(e){var r=e.find((function(t){return!0===t.main})),i=e.filter((function(t){return!0!==t.main}));if(r?o.innerHTML=t.createPhotoElement(r):o.parentElement.classList.add("hidden"),i.length){var a="";i.forEach((function(e){return a+=t.createPhotoElement(e)})),a+=t.createPhotoElement({main:!1,empty:!0,photoId:null}),n.innerHTML=a}t.initEvents()}})).catch((function(e){t.handleError({message:e}),t.initEvents()})),this.initEvents()}},{key:"createPhotoElement",value:function(t){var e=t.photoId,o=t.main,n=t.empty,r=t.path,i=t.avatarUrl,a=this.disableControls,u="",s="",l="",c="";return r&&(l='style="background-image: url('.concat(r,')"')),i&&(l='style="background-image: url('.concat(i,')"')),o&&(c='data-main="'.concat(o,'"')),o&&!n?(s="vg-photo vg-photo--main",u='\n        <button class="vg-photo__button vg-button vg-button--red" data-action="remove-photo">Удалить</button>\n      '):o&&n?(s="vg-photo vg-photo--main",u='\n        <button class="vg-photo__button vg-button" data-action="upload-photo">Загрузить</button>\n      '):!o&&n?(s="vg-gallery__item vg-photo vg-photo--upload",u='\n        <button class="vg-photo__button vg-button vg-button--upload" data-action="upload-photo">&#43;</button>\n      '):(s="vg-gallery__item vg-photo",u='\n        <button class="vg-photo__button vg-button vg-button--green" data-action="update-photo">Выбрать</button>\n        <button class="vg-photo__button vg-button vg-button--red" data-action="remove-photo">Удалить</button>\n      '),'\n      <div class="'.concat(s,'"\n        ').concat(l,'\n        data-photo-id="').concat(e,'"\n        ').concat(c,">\n        ").concat(a?"":u,"\n        </div>\n      ")}},{key:"initEvents",value:function(){var t=this;this.rootElement.querySelectorAll("button").forEach((function(e){e.addEventListener("click",t.router[e.dataset.action],!1)}))}}],(o=[{key:"errorFunction",get:function(){return this.constructor.errorFunction},set:function(t){t&&(this.constructor.errorFunction=t)}},{key:"employeeId",get:function(){return this.constructor.employeeId},set:function(t){t&&(this.constructor.employeeId=t)}},{key:"rootElement",get:function(){return this.constructor.rootElement}},{key:"token",get:function(){return this.constructor.token},set:function(t){t&&(this.constructor.token=t)}},{key:"disableControls",get:function(){return this.constructor.token},set:function(t){t&&(this.constructor.disableControls=t)}}])&&r(e.prototype,o),i&&r(e,i),t}();i(a,"employeeId",null),i(a,"rootElement",null),i(a,"token",null),i(a,"disableControls",!1),i(a,"errorFunction",null),i(a,"router",{"upload-photo":function(t){var e=a.rootElement.querySelector('input[type="file"]');e.addEventListener("change",a.router["file-input-changed"]),e.click()},"file-input-changed":function(t){var e=t.target.files[0],o=new FileReader;o.readAsDataURL(e),o.onload=function(){a.addPhoto(o.result).then((function(t){if(t.ok)a.draw();else if(200!==t.status)return t.json()})).then((function(t){200!==t.status&&a.handleError({message:t})}))},o.onerror=function(){a.handleError({message:o.error,blockingErrorMessage:"Ошибка загрузки фотографии (-ий): ".concat(o.error)})}},"remove-photo":function(t){var e=t.target.closest(".vg-photo").dataset.photoId;e&&a.deletePhoto(+e).then((function(t){if(t.ok)a.draw();else if(200!==t.status)return t.json()})).then((function(t){200!==t.status&&a.handleError({message:t})}))},"update-photo":function(t){var e=t.target.closest(".vg-photo").dataset.photoId;e&&a.updatePhoto(+e).then((function(t){if(t.ok)a.draw();else if(200!==t.status)return t.json()})).then((function(t){200!==t.status&&a.handleError({message:t})}))}})}},e={};function o(n){if(e[n])return e[n].exports;var r=e[n]={exports:{}};return t[n](r,r.exports,o),r.exports}return o.d=function(t,e){for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o(946)}().default}));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9WaXNpb25QaG90b0dhbGxlcnkvd2VicGFjay91bml2ZXJzYWxNb2R1bGVEZWZpbml0aW9uIiwid2VicGFjazovL1Zpc2lvblBob3RvR2FsbGVyeS8uL1Zpc2lvblBob3RvR2FsbGVyeS9pbmRleC5qcyIsIndlYnBhY2s6Ly9WaXNpb25QaG90b0dhbGxlcnkvd2VicGFjay9ib290c3RyYXAiLCJ3ZWJwYWNrOi8vVmlzaW9uUGhvdG9HYWxsZXJ5L3dlYnBhY2svc3RhcnR1cCIsIndlYnBhY2s6Ly9WaXNpb25QaG90b0dhbGxlcnkvd2VicGFjay9ydW50aW1lL2RlZmluZSBwcm9wZXJ0eSBnZXR0ZXJzIiwid2VicGFjazovL1Zpc2lvblBob3RvR2FsbGVyeS93ZWJwYWNrL3J1bnRpbWUvaGFzT3duUHJvcGVydHkgc2hvcnRoYW5kIl0sIm5hbWVzIjpbInJvb3QiLCJmYWN0b3J5IiwiZXhwb3J0cyIsIm1vZHVsZSIsImRlZmluZSIsImFtZCIsInRoaXMiLCJWaXNpb25QaG90b0dhbGxlcnkiLCJlbXBsb3llZUlkIiwidG9rZW4iLCJkaXNhYmxlQ29udHJvbHMiLCJFcnJvciIsInJvb3RFbGVtZW50IiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsImNvbnN0cnVjdG9yIiwiZHJhdyIsInBhcmFtcyIsIm1lc3NhZ2UiLCJibG9ja2luZ0Vycm9yTWVzc2FnZSIsImVycm9yRnVuY3Rpb24iLCJtZXNzYWdlU3RyaW5nIiwiT2JqZWN0Iiwia2V5cyIsInJldmVyc2UiLCJmb3JFYWNoIiwia2V5IiwiZXJyb3JNZXNzYWdlIiwibGVuZ3RoIiwiSlNPTiIsInN0cmluZ2lmeSIsImNvbnNvbGUiLCJsb2ciLCJyZXF1ZXN0UGF0aCIsInJlcXVlc3RCb2R5IiwicmVxdWVzdERlZmF1bHRzIiwibWV0aG9kIiwibW9kZSIsImNyZWRlbnRpYWxzIiwiaGVhZGVycyIsImJvZHkiLCJmZXRjaCIsInJlcXVlc3QiLCJtYXN0ZXJBbGJ1bSIsImltYWdlIiwicGhvdG9JZCIsInBob3RvSWRzIiwicGhvdG9faWQiLCJpbm5lckhUTUwiLCJtYWluUGhvdG9Db250YWluZXIiLCJxdWVyeVNlbGVjdG9yIiwiZ2FsbGVyeSIsImdldFBob3RvcyIsInRoZW4iLCJyZXNwb25zZSIsImNyZWF0ZVBob3RvRWxlbWVudCIsIm1haW4iLCJlbXB0eSIsIm9rIiwianNvbiIsImluaXRFdmVudHMiLCJyZXNwb25zZUpzb24iLCJtYWluUGhvdG9EYXRhIiwiZmluZCIsImdhbGxlcnlQaG90b3NEYXRhIiwiZmlsdGVyIiwicGFyZW50RWxlbWVudCIsImNsYXNzTGlzdCIsImFkZCIsImdhbGxlcnlQaG90b3NIdG1sIiwicGhvdG9EYXRhIiwiY2F0Y2giLCJlcnJvciIsImhhbmRsZUVycm9yIiwicGF0aCIsImF2YXRhclVybCIsImlzQ29udHJvbHNEaXNhYmxlZCIsImJ1dHRvbnMiLCJlbGVtZW50Q2xhc3NlcyIsImJhY2tncm91bmRJbWFnZSIsIm1haW5BdHRyaWJ1dGUiLCJxdWVyeVNlbGVjdG9yQWxsIiwiYnV0dG9uIiwiYWRkRXZlbnRMaXN0ZW5lciIsInJvdXRlciIsImRhdGFzZXQiLCJhY3Rpb24iLCJ2YWx1ZSIsImUiLCJmaWxlSW5wdXQiLCJjbGljayIsImZpbGUiLCJ0YXJnZXQiLCJmaWxlcyIsInJlYWRlciIsIkZpbGVSZWFkZXIiLCJyZWFkQXNEYXRhVVJMIiwib25sb2FkIiwiYWRkUGhvdG8iLCJyZXN1bHQiLCJzdGF0dXMiLCJvbmVycm9yIiwiY2xvc2VzdCIsImRlbGV0ZVBob3RvIiwidXBkYXRlUGhvdG8iLCJfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18iLCJfX3dlYnBhY2tfcmVxdWlyZV9fIiwibW9kdWxlSWQiLCJfX3dlYnBhY2tfbW9kdWxlc19fIiwiZCIsImRlZmluaXRpb24iLCJvIiwiZGVmaW5lUHJvcGVydHkiLCJlbnVtZXJhYmxlIiwiZ2V0Iiwib2JqIiwicHJvcCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCJdLCJtYXBwaW5ncyI6IkNB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QUF5QkUsR0FDM0IsT0FBT0YsRUFBeUJFLEdBQVV6RyxRQUczQyxJQUFJQyxFQUFTc0csRUFBeUJFLEdBQVksQ0FHakR6RyxRQUFTLElBT1YsT0FIQTBHLEVBQW9CRCxHQUFVeEcsRUFBUUEsRUFBT0QsUUFBU3dHLEdBRy9DdkcsRUFBT0QsUUNqQmYsT0NGQXdHLEVBQW9CRyxFQUFJLFNBQVMzRyxFQUFTNEcsR0FDekMsSUFBSSxJQUFJcEYsS0FBT29GLEVBQ1hKLEVBQW9CSyxFQUFFRCxFQUFZcEYsS0FBU2dGLEVBQW9CSyxFQUFFN0csRUFBU3dCLElBQzVFSixPQUFPMEYsZUFBZTlHLEVBQVN3QixFQUFLLENBQUV1RixZQUFZLEVBQU1DLElBQUtKLEVBQVdwRixNQ0ozRWdGLEVBQW9CSyxFQUFJLFNBQVNJLEVBQUtDLEdBQVEsT0FBTzlGLE9BQU8rRixVQUFVQyxlQUFlQyxLQUFLSixFQUFLQyxJRkd4RlYsRUFBb0IsSyIsImZpbGUiOiJWaXNpb25QaG90b0dhbGxlcnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gd2VicGFja1VuaXZlcnNhbE1vZHVsZURlZmluaXRpb24ocm9vdCwgZmFjdG9yeSkge1xuXHRpZih0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpXG5cdFx0bW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7XG5cdGVsc2UgaWYodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKVxuXHRcdGRlZmluZShbXSwgZmFjdG9yeSk7XG5cdGVsc2UgaWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKVxuXHRcdGV4cG9ydHNbXCJWaXNpb25QaG90b0dhbGxlcnlcIl0gPSBmYWN0b3J5KCk7XG5cdGVsc2Vcblx0XHRyb290W1wiVmlzaW9uUGhvdG9HYWxsZXJ5XCJdID0gZmFjdG9yeSgpO1xufSkodGhpcywgZnVuY3Rpb24oKSB7XG5yZXR1cm4gIiwiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgJy4vYXBwLnNjc3MnO1xuXG4vKipcbiAqINCa0LvQsNGB0YEg0LPQsNC70LXRgNC10LguXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFZpc2lvblBob3RvR2FsbGVyeSB7XG4gIHN0YXRpYyBlbXBsb3llZUlkID0gbnVsbDtcbiAgc3RhdGljIHJvb3RFbGVtZW50ID0gbnVsbDtcbiAgc3RhdGljIHRva2VuID0gbnVsbDtcbiAgc3RhdGljIGRpc2FibGVDb250cm9scyA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiDQmtC+0L3RgdGC0YDRg9C60YLQvtGAINGN0LrQt9C10LzQv9C70Y/RgNCwINC60LvQsNGB0YHQsCDQs9Cw0LvQtdGA0LXQuC5cbiAgICogQHBhcmFtIHJvb3Qge3N0cmluZ30gSUQg0LrQvtGA0L3QtdCy0L7Qs9C+INGN0LvQtdC80LXQvdGC0LAsINC60YPQtNCwINCx0YPQtNC10YIg0YDQtdC90LTQtdGA0LjRgtGM0YHRjyDQs9Cw0LvQtdGA0LXRjy5cbiAgICogQHBhcmFtIGVtcGxveWVlSWQge251bWJlcnxzdHJpbmd9IElEINGB0L7RgtGA0YPQtNC90LjQutCwLlxuICAgKiBAcGFyYW0gdG9rZW4ge3N0cmluZ30gQ1NSRi3RgtC+0LrQtdC9INC/0L7Qu9GM0LfQvtCy0LDRgtC10LvRjy5cbiAgICogQHBhcmFtIGRpc2FibGVDb250cm9scyB7Ym9vbGVhbn0g0J7RgtC60LvRjtGH0LjRgtGMINCy0L7Qt9C80L7QttC90L7RgdGC0Ywg0LfQsNCz0YDRg9C30LrQuCwg0L7QsdC90L7QstC70LXQvdC40Y8g0Lgg0YPQtNCw0LvQtdC90LjRjyDRhNC+0YLQvtCz0YDQsNGE0LjQuS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHtyb290LCBlbXBsb3llZUlkLCB0b2tlbiwgZGlzYWJsZUNvbnRyb2xzID0gZmFsc2V9KSB7XG4gICAgaWYgKCFyb290KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ9Cd0LUg0YPQutCw0LfQsNC9IElEINC60L7RgNC90LXQstC+0LPQviDRjdC70LXQvNC10L3RgtCwINC00LvRjyDQs9Cw0LvQtdGA0LXQuCEnKTtcbiAgICB9XG5cbiAgICBjb25zdCByb290RWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJvb3QpO1xuXG4gICAgaWYgKCEhcm9vdEVsZW1lbnQpIHtcbiAgICAgIHRoaXMuY29uc3RydWN0b3Iucm9vdEVsZW1lbnQgPSByb290RWxlbWVudDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCfQn9GA0L7QstC10YDRjNGC0LUg0YPQutCw0LfQsNC90L3Ri9C5IElEINC60L7RgNC90LXQstC+0LPQviDRjdC70LXQvNC10L3RgtCwINC00LvRjyDQs9Cw0LvQtdGA0LXQuCEnKTtcbiAgICB9XG5cbiAgICBpZiAoIWVtcGxveWVlSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign0J3QtSDRg9C60LDQt9Cw0L0gSUQg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9GPINC90LAg0L/QvtGA0YLQsNC70LUgVmlzaW9uJyk7XG4gICAgfVxuXG4gICAgdGhpcy5lbXBsb3llZUlkID0gZW1wbG95ZWVJZDtcbiAgICB0aGlzLnRva2VuID0gdG9rZW47XG4gICAgdGhpcy5kaXNhYmxlQ29udHJvbHMgPSBkaXNhYmxlQ29udHJvbHM7XG5cbiAgICB0aGlzLmNvbnN0cnVjdG9yLmRyYXcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDQndCw0LfQvdCw0YfQsNC10LzRi9C5INC80LXRgtC+0LQg0LTQu9GPINC+0YLQvtCx0YDQsNC20LXQvdC40Y8g0L7RiNC40LHQvtC6LlxuICAgKiBAdHlwZSB7bnVsbHxGdW5jdGlvbn0g0KTRg9C90LrRhtC40Y8g0L7QsdGA0LDQsdC+0YLRh9C40Log0L7RgtC+0LHRgNCw0LbQtdC90LjRjyDQvtGI0LjQsdC+0LouXG4gICAqL1xuICBzdGF0aWMgZXJyb3JGdW5jdGlvbiA9IG51bGw7XG4gIC8qKlxuICAgKiDQn9C+0LvRg9GH0LXQvdC40LUg0LzQtdGC0L7QtNCwINC00LvRjyDQvtGC0L7QsdGA0LDQttC10L3QuNGPINC+0YjQuNCx0L7Qui5cbiAgICogQHR5cGUge251bGx8RnVuY3Rpb259INCk0YPQvdC60YbQuNGPINC+0LHRgNCw0LHQvtGC0YfQuNC6INC+0YLQvtCx0YDQsNC20LXQvdC40Y8g0L7RiNC40LHQvtC6LlxuICAgKi9cbiAgZ2V0IGVycm9yRnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuZXJyb3JGdW5jdGlvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiDQndCw0LfQvdCw0YfQtdC90LjQtSDQvNC10YLQvtC00LAg0LTQu9GPINC+0YLQvtCx0YDQsNC20LXQvdC40Y8g0L7RiNC40LHQvtC6LlxuICAgKiBAcGFyYW0gZXJyb3JGdW5jdGlvbiB7bnVsbHxGdW5jdGlvbn0g0KTRg9C90LrRhtC40Y8g0L7QsdGA0LDQsdC+0YLRh9C40Log0L7RgtC+0LHRgNCw0LbQtdC90LjRjyDQvtGI0LjQsdC+0LouXG4gICAqL1xuICBzZXQgZXJyb3JGdW5jdGlvbihlcnJvckZ1bmN0aW9uKSB7XG4gICAgaWYgKGVycm9yRnVuY3Rpb24pIHtcbiAgICAgIHRoaXMuY29uc3RydWN0b3IuZXJyb3JGdW5jdGlvbiA9IGVycm9yRnVuY3Rpb247XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqINCe0LHQvdC+0LLQu9C10L3QuNC1INC/0LDRgNCw0LzQtdGC0YDQvtCyINCz0LDQu9C10YDQtdC4LlxuICAgKiBAcGFyYW0gZW1wbG95ZWVJZCB7bnVtYmVyfG51bWJlcn0gSUQg0YHQvtGC0YDRg9C00L3QuNC60LAuXG4gICAqIEBwYXJhbSB0b2tlbiB7c3RyaW5nfSBDU1JGLdGC0L7QutC10L0g0YHQtdGB0YHQuCDQv9C+0LvRjNC30L7QstCw0YLQtdC70Y8uXG4gICAqL1xuICBzdGF0aWMgdXBkYXRlKHtlbXBsb3llZUlkLCB0b2tlbn0pIHtcbiAgICB0aGlzLmVtcGxveWVlSWQgPSBlbXBsb3llZUlkO1xuICAgIHRoaXMudG9rZW4gPSB0b2tlbjtcblxuICAgIHRoaXMuZHJhdygpO1xuICB9XG5cbiAgLyoqXG4gICAqINCf0L7Qu9GD0YfQuNGC0YwgSUQg0YHQvtGC0YDRg9C00L3QuNC60LAuXG4gICAqIEByZXR1cm4ge251bWJlcnxzdHJpbmd9IElEINGB0L7RgtGA0YPQtNC90LjQutCwLlxuICAgKi9cbiAgZ2V0IGVtcGxveWVlSWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuZW1wbG95ZWVJZDtcbiAgfVxuXG4gIC8qKlxuICAgKiDQndCw0LfQvdCw0YfQtdC90LjQtSDRjdC60LfQtdC80L/Qu9GP0YDRgyDQs9Cw0LvQtdGA0LXQuCBJRCDRgdC+0YLRgNGD0LTQvdC40LrQsC5cbiAgICogQHBhcmFtIGVtcGxveWVlSWQge251bWJlcnxzdHJpbmd9IElEINGB0L7RgtGA0YPQtNC90LjQutCwLlxuICAgKi9cbiAgc2V0IGVtcGxveWVlSWQoZW1wbG95ZWVJZCkge1xuICAgIGlmIChlbXBsb3llZUlkKSB7XG4gICAgICB0aGlzLmNvbnN0cnVjdG9yLmVtcGxveWVlSWQgPSBlbXBsb3llZUlkO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDQmtC+0YDQvdC10LLQvtC5INGN0LvQtdC80LXQvdGCLCDQsiDQutC+0YLQvtGA0YvQuSDQsdGD0LTQtdGCINGA0LXQvdC00LXRgNC40YLRjNGB0Y8g0LPQsNC70LXRgNC10Y8uXG4gICAqIEByZXR1cm4ge251bGx8RWxlbWVudH0g0JrQvtGA0L3QtdCy0L7QuSDRjdC70LXQvNC10L3RgiDQtNC70Y8g0YDQtdC90LTQtdGA0LAuXG4gICAqL1xuICBnZXQgcm9vdEVsZW1lbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iucm9vdEVsZW1lbnQ7XG4gIH1cblxuICAvKipcbiAgICog0J/QvtC70YPRh9C40YLRjCBDU1JGLdGC0L7QutC10L0g0YHQtdGB0YHQuNC4INC/0L7Qu9GM0LfQvtCy0LDRgtC10LvRjy5cbiAgICogQHJldHVybiB7bnVsbHxzdHJpbmd9IENTUkYt0YLQvtC60LXQvSDRgdC10YHRgdC40Lgg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9GPLlxuICAgKi9cbiAgZ2V0IHRva2VuKCkge1xuICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRva2VuO1xuICB9XG5cbiAgLyoqXG4gICAqINCd0LDQt9C90LDRh9C40YLRjCBDU1JGLdGC0L7QutC10L0g0YHQtdGB0YHQuNC4INC/0L7Qu9GM0LfQvtCy0LDRgtC10LvRjy5cbiAgICogQHBhcmFtIHRva2VuIHtzdHJpbmd9IENTUkYt0YLQvtC60LXQvSDRgdC10YHRgdC40Lgg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9GPLlxuICAgKi9cbiAgc2V0IHRva2VuKHRva2VuKSB7XG4gICAgaWYgKHRva2VuKSB7XG4gICAgICB0aGlzLmNvbnN0cnVjdG9yLnRva2VuID0gdG9rZW47XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqINCf0L7Qu9GD0YfQuNGC0Ywg0LfQvdCw0YfQtdC90LjQtSDRgdC+0YHRgtC+0Y/QvdC40Y8g0LrQvtC90YLRgNC+0LvQvtCyLlxuICAgKiBAcmV0dXJuIHtib29sZWFufSDQodC+0YHRgtC+0Y/QvdC40LUg0LrQvtC90YLRgNC+0LvQvtCyLlxuICAgKi9cbiAgZ2V0IGRpc2FibGVDb250cm9scygpIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b2tlbjtcbiAgfVxuXG4gIC8qKlxuICAgKiDQndCw0LfQvdCw0YfQuNGC0YwgQ1NSRi3RgtC+0LrQtdC9INGB0LXRgdGB0LjQuCDQv9C+0LvRjNC30L7QstCw0YLQtdC70Y8uXG4gICAqIEBwYXJhbSB2YWx1ZSB7Ym9vbGVhbn0g0JLQutC70Y7Rh9C40YLRjC/QvtGC0LrQu9GO0YfQuNGC0Ywg0LrQvtC90YLRgNC+0LvRiy5cbiAgICovXG4gIHNldCBkaXNhYmxlQ29udHJvbHModmFsdWUpIHtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHRoaXMuY29uc3RydWN0b3IuZGlzYWJsZUNvbnRyb2xzID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqINCe0LHRgNCw0LHQvtGC0YfQuNC6INC+0YjQuNCx0L7Qui5cbiAgICogQHBhcmFtIHBhcmFtcy5tZXNzYWdlIHtzdHJpbmd9INCh0L7QvtCx0YnQtdC90LjQtSDQvtCxINC+0YjQuNCx0LrQtS5cbiAgICogQHBhcmFtIHBhcmFtcy5ibG9ja2luZ0Vycm9yTWVzc2FnZSB7c3RyaW5nfSDQkdC70L7QutC40YDRg9GO0YnQtdC1INC/0L7RgtC+0Log0YHQvtC+0LHRidC10L3QuNC1INC+0LEg0L7RiNC40LHQutC1LlxuICAgKi9cbiAgc3RhdGljIGhhbmRsZUVycm9yKHBhcmFtcykge1xuICAgIGNvbnN0IHttZXNzYWdlLCBibG9ja2luZ0Vycm9yTWVzc2FnZX0gPSBwYXJhbXM7XG5cbiAgICBpZiAodGhpcy5lcnJvckZ1bmN0aW9uKSB7XG4gICAgICBsZXQgbWVzc2FnZVN0cmluZyA9ICcnO1xuXG4gICAgICBpZiAodHlwZW9mIG1lc3NhZ2UgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKG1lc3NhZ2UpLnJldmVyc2UoKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgbWVzc2FnZVN0cmluZyArPSBgJHttZXNzYWdlW2tleV19PGJyLz5gO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gbWVzc2FnZVN0cmluZy5sZW5ndGggPyBtZXNzYWdlU3RyaW5nIDogSlNPTi5zdHJpbmdpZnkobWVzc2FnZSk7XG5cbiAgICAgIHRoaXMuZXJyb3JGdW5jdGlvbihlcnJvck1lc3NhZ2UsICfQntGI0LjQsdC60LAnKTtcbiAgICB9IGVsc2UgaWYgKGJsb2NraW5nRXJyb3JNZXNzYWdlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYmxvY2tpbmdFcnJvck1lc3NhZ2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhtZXNzYWdlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog0J7QsdGR0YDRgtC60LAg0LTQu9GPINC30LDQv9GA0L7RgdC+0LIg0LogQVBJLlxuICAgKiBAcGFyYW0gcmVxdWVzdFBhdGgge3N0cmluZ30g0J3QsNC30LLQsNC90LjQtSDQvNC10YLQvtC00LAgQVBJLlxuICAgKiBAcGFyYW0gcmVxdWVzdEJvZHkge29iamVjdH0g0J/QsNGA0LDQvNC10YLRgNGLINC30LDQv9GA0L7RgdCwLlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxSZXNwb25zZT59INCf0YDQvtC80LjRgSDQt9Cw0L/RgNC+0YHQsC5cbiAgICovXG4gIHN0YXRpYyByZXF1ZXN0KHtyZXF1ZXN0UGF0aCwgcmVxdWVzdEJvZHl9KSB7XG4gICAgY29uc3QgcmVxdWVzdERlZmF1bHRzID0ge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBtb2RlOiAnc2FtZS1vcmlnaW4nLFxuICAgICAgY3JlZGVudGlhbHM6ICdzYW1lLW9yaWdpbicsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdYLUNTUkZUb2tlbic6IHRoaXMudG9rZW4sXG4gICAgICB9LFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpLFxuICAgIH07XG5cbiAgICByZXR1cm4gZmV0Y2goYC9hcGkvdjIvdmlzaW9uLyR7cmVxdWVzdFBhdGh9L2AsIHJlcXVlc3REZWZhdWx0cyk7XG4gIH1cblxuICAvKipcbiAgICog0JLRi9Cz0YDRg9C30LrQsCDQstGB0LXRhSDRhNC+0YLQvtCz0YDQsNGE0LjQuSDRgSDQv9C+0YDRgtCw0LvQsCBWaXNpb24uXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFJlc3BvbnNlPn0g0J/RgNC+0LzQuNGBINGBINGA0LXQt9GD0LvRjNGC0LDRgtC+0Lwg0LLRi9C/0L7Qu9C90LXQvdC40Y8g0LfQsNC/0YDQvtGB0LAuXG4gICAqL1xuICBzdGF0aWMgZ2V0UGhvdG9zKCkge1xuICAgIHJldHVybiB0aGlzLnJlcXVlc3Qoe1xuICAgICAgcmVxdWVzdFBhdGg6ICdnZXRfcGhvdG9zJyxcbiAgICAgIHJlcXVlc3RCb2R5OiB7XG4gICAgICAgIGVtcGxveWVlSWQ6IHRoaXMuZW1wbG95ZWVJZCxcbiAgICAgICAgbWFzdGVyQWxidW06IHRydWUsXG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog0JfQsNC/0YDQvtGBINC90LAg0LTQvtCx0LDQstC70LXQvdC40LUgKNC30LDQs9GA0YPQt9C60YMpINGE0L7RgtC+0LPRgNCw0YTQuNC4LlxuICAgKiBAcGFyYW0gaW1hZ2Uge0J1ZmZlckVuY29kaW5nfSDQpNC+0YLQvtCz0YDQsNGE0LjQuCDQsiDRhNC+0YDQvNCw0YLQtSBCYXNlNjQuXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPFJlc3BvbnNlPn0g0J/RgNC+0LzQuNGBINGBINGA0LXQt9GD0LvRjNGC0LDRgtC+0Lwg0LLRi9C/0L7Qu9C90LXQvdC40Y8g0LfQsNC/0YDQvtGB0LAuXG4gICAqL1xuICBzdGF0aWMgYWRkUGhvdG8oaW1hZ2UpIHtcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHtcbiAgICAgIHJlcXVlc3RQYXRoOiAnYWRkX3Bob3RvJyxcbiAgICAgIHJlcXVlc3RCb2R5OiB7XG4gICAgICAgIGVtcGxveWVlSWQ6IHRoaXMuZW1wbG95ZWVJZCxcbiAgICAgICAgaW1hZ2UsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqINCX0LDQv9GA0L7RgSDQvdCwINGD0LTQsNC70LXQvdC40LUg0YTQvtGC0L7Qs9GA0LDRhNC40LguXG4gICAqIEBwYXJhbSBwaG90b0lkIHtOdW1iZXJ9IElEINGE0L7RgtC+0LPRgNCw0YTQuNC4INC90LAg0L/QvtGA0YLQsNC70LUgVmlzaW9uLlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxSZXNwb25zZT59INCf0YDQvtC80LjRgSDRgSDRgNC10LfRg9C70YzRgtCw0YLQvtC8INCy0YvQv9C+0LvQvdC10L3QuNGPINC30LDQv9GA0L7RgdCwLlxuICAgKi9cbiAgc3RhdGljIGRlbGV0ZVBob3RvKHBob3RvSWQpIHtcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KHtcbiAgICAgIHJlcXVlc3RQYXRoOiAnZGVsZXRlX3Bob3RvJyxcbiAgICAgIHJlcXVlc3RCb2R5OiB7XG4gICAgICAgIGVtcGxveWVlSWQ6IHRoaXMuZW1wbG95ZWVJZCxcbiAgICAgICAgcGhvdG9JZHM6IFtwaG90b0lkXSxcbiAgICAgICAgbWFzdGVyQWxidW06IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqINCX0LDQv9GA0L7RgSDQvdCwINC+0LHQvdC+0LLQu9C10L3QuNC1INGE0L7RgtC+0LPRgNCw0YTQuNC4LlxuICAgKiBAcGFyYW0gcGhvdG9JZCB7TnVtYmVyfSBJRCDRhNC+0YLQvtCz0YDQsNGE0LjQuCDQvdCwINC/0L7RgNGC0LDQu9C1IFZpc2lvbi5cbiAgICogQHJldHVybnMge1Byb21pc2U8UmVzcG9uc2U+fSDQn9GA0L7QvNC40YEg0YEg0YDQtdC30YPQu9GM0YLQsNGC0L7QvCDQstGL0L/QvtC70L3QtdC90LjRjyDQt9Cw0L/RgNC+0YHQsC5cbiAgICovXG4gIHN0YXRpYyB1cGRhdGVQaG90byhwaG90b0lkKSB7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdCh7XG4gICAgICByZXF1ZXN0UGF0aDogJ3VwZGF0ZV9waG90bycsXG4gICAgICByZXF1ZXN0Qm9keToge1xuICAgICAgICBlbXBsb3llZUlkOiB0aGlzLmVtcGxveWVlSWQsXG4gICAgICAgIHBob3RvX2lkOiBwaG90b0lkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDQntGC0YDQuNGB0L7QstC60LAgRE9NINCz0LDQu9C10YDQtdC40LguXG4gICAqL1xuICBzdGF0aWMgZHJhdygpIHtcbiAgICBjb25zdCByb290RWxlbWVudCA9IHRoaXMucm9vdEVsZW1lbnQ7XG5cbiAgICByb290RWxlbWVudC5pbm5lckhUTUwgPSBgXG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwidmlzaW9uLXBob3RvLWdhbGxlcnlcIj5cbiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT1cImZpbGVcIiBjbGFzcz1cInZpc2lvbi1waG90by1nYWxsZXJ5X19maWxlLWZpZWxkXCIgdGFiaW5kZXg9XCItMVwiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJ2aXNpb24tcGhvdG8tZ2FsbGVyeV9faXRlbSB2aXNpb24tcGhvdG8tZ2FsbGVyeV9faXRlbS0tbWFpblwiPlxuICAgICAgICAgICAgICAgICAgICA8aDQgY2xhc3M9XCJ2aXNpb24tcGhvdG8tZ2FsbGVyeV9fdGl0bGVcIj7QntGB0L3QvtCy0L3QsNGPINGE0L7RgtC+0LPRgNCw0YTQuNGPPC9oND5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cInZnLW1haW4tcGhvdG9cIj48L2Rpdj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwidmlzaW9uLXBob3RvLWdhbGxlcnlfX2l0ZW1cIj5cbiAgICAgICAgICAgICAgICAgICAgPGg0IGNsYXNzPVwidmlzaW9uLXBob3RvLWdhbGxlcnlfX3RpdGxlXCI+0JPQsNC70LXRgNC10Y88L2g0PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwidmctZ2FsbGVyeVwiPjwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgIGA7XG5cbiAgICBjb25zdCBtYWluUGhvdG9Db250YWluZXIgPSByb290RWxlbWVudC5xdWVyeVNlbGVjdG9yKCcudmctbWFpbi1waG90bycpO1xuICAgIGNvbnN0IGdhbGxlcnkgPSByb290RWxlbWVudC5xdWVyeVNlbGVjdG9yKCcudmctZ2FsbGVyeScpO1xuXG4gICAgdGhpcy5nZXRQaG90b3MoKS50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgIG1haW5QaG90b0NvbnRhaW5lci5pbm5lckhUTUwgPSB0aGlzLmNyZWF0ZVBob3RvRWxlbWVudCh7XG4gICAgICAgIG1haW46IHRydWUsXG4gICAgICAgIGVtcHR5OiB0cnVlLFxuICAgICAgICBwaG90b0lkOiBudWxsXG4gICAgICB9KTtcblxuICAgICAgZ2FsbGVyeS5pbm5lckhUTUwgPSB0aGlzLmNyZWF0ZVBob3RvRWxlbWVudCh7XG4gICAgICAgIG1haW46IGZhbHNlLFxuICAgICAgICBlbXB0eTogdHJ1ZSxcbiAgICAgICAgcGhvdG9JZDogbnVsbCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1haW5QaG90b0NvbnRhaW5lci5pbm5lckhUTUwgPSB0aGlzLmNyZWF0ZVBob3RvRWxlbWVudCh7bWFpbjogdHJ1ZSwgZW1wdHk6IHRydWUsIHBob3RvSWQ6IG51bGx9KTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5pbml0RXZlbnRzKCk7XG4gICAgfSkudGhlbihyZXNwb25zZUpzb24gPT4ge1xuICAgICAgaWYgKCFyZXNwb25zZUpzb24pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBtYWluUGhvdG9EYXRhID0gcmVzcG9uc2VKc29uLmZpbmQoKHttYWlufSkgPT4gbWFpbiA9PT0gdHJ1ZSk7XG4gICAgICBjb25zdCBnYWxsZXJ5UGhvdG9zRGF0YSA9IHJlc3BvbnNlSnNvbi5maWx0ZXIoKHttYWlufSkgPT4gbWFpbiAhPT0gdHJ1ZSk7XG5cbiAgICAgIGlmICghIW1haW5QaG90b0RhdGEpIHtcbiAgICAgICAgbWFpblBob3RvQ29udGFpbmVyLmlubmVySFRNTCA9IHRoaXMuY3JlYXRlUGhvdG9FbGVtZW50KG1haW5QaG90b0RhdGEpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWFpblBob3RvQ29udGFpbmVyLnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChnYWxsZXJ5UGhvdG9zRGF0YS5sZW5ndGgpIHtcbiAgICAgICAgbGV0IGdhbGxlcnlQaG90b3NIdG1sID0gJyc7XG5cbiAgICAgICAgZ2FsbGVyeVBob3Rvc0RhdGEuZm9yRWFjaCgocGhvdG9EYXRhKSA9PiBnYWxsZXJ5UGhvdG9zSHRtbCArPSB0aGlzLmNyZWF0ZVBob3RvRWxlbWVudChwaG90b0RhdGEpKTtcbiAgICAgICAgZ2FsbGVyeVBob3Rvc0h0bWwgKz0gdGhpcy5jcmVhdGVQaG90b0VsZW1lbnQoe21haW46IGZhbHNlLCBlbXB0eTogdHJ1ZSwgcGhvdG9JZDogbnVsbH0pO1xuICAgICAgICBnYWxsZXJ5LmlubmVySFRNTCA9IGdhbGxlcnlQaG90b3NIdG1sXG4gICAgICB9XG5cbiAgICAgIHRoaXMuaW5pdEV2ZW50cygpO1xuICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIHRoaXMuaGFuZGxlRXJyb3Ioe1xuICAgICAgICBtZXNzYWdlOiBlcnJvcixcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmluaXRFdmVudHMoKTtcbiAgICB9KTtcblxuICAgIHRoaXMuaW5pdEV2ZW50cygpO1xuICB9XG5cbiAgLyoqXG4gICAqINCj0L3QuNCy0LXRgNGB0LDQu9GM0L3Ri9C5INC80LXRgtC+0LQg0LTQu9GPINGB0L7Qt9C00LDQvdC40Y8g0Y3Qu9C10LzQtdC90YLQsCDRhNC+0YLQvtCz0YDQsNGE0LjQuC5cbiAgICogQHBhcmFtIHBhcmFtcy5waG90b0lkIHtOdW1iZXJ9IElEINGE0L7RgtC+0LPRgNCw0YTQuNC4INC90LAg0L/QvtGA0YLQsNC70LUgVmlzaW9uLlxuICAgKiBAcGFyYW0gcGFyYW1zLm1haW4ge0Jvb2xlYW59ICDQpNC70LDQsyDQvtGB0L3QvtCy0L3QvtCz0L4g0YTQvtGC0L4uXG4gICAqIEBwYXJhbSBwYXJhbXMuZW1wdHkge0Jvb2xlYW59INCk0LvQsNCzIFwi0L/Rg9GB0YLQvtCz0L5cIiDRhNC+0YLQviwg0LjRgdC/0L7Qu9GM0LfRg9C10YLRgdGPINC00LvRjyDQvtGC0L7QsdGA0LDQttC10L3QuNGPINC60L3QvtC/0LrQuCDQt9Cw0LPRgNGD0LfQutC4LlxuICAgKiBAcGFyYW0gcGFyYW1zLnBhdGgge1N0cmluZ30g0J/Rg9GC0Ywg0Log0YTQvtGC0L7Qs9GA0LDRhNC40LguXG4gICAqIEBwYXJhbSBwYXJhbXMuYXZhdGFyVXJsIHtTdHJpbmd9INCf0YPRgtGMINC6INGE0L7RgtC+0LPRgNCw0YTQuNC4LlxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSDQrdC70LXQvNC10L3RgiDRhNC+0YLQvtCz0YDQsNGE0LjQuCDQsiDQstC40LTQtSDRgdGC0YDQvtC60LguXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlUGhvdG9FbGVtZW50KHBhcmFtcykge1xuICAgIGNvbnN0IHtwaG90b0lkLCBtYWluLCBlbXB0eSwgcGF0aCwgYXZhdGFyVXJsfSA9IHBhcmFtcztcbiAgICBjb25zdCB7ZGlzYWJsZUNvbnRyb2xzOiBpc0NvbnRyb2xzRGlzYWJsZWR9ID0gdGhpcztcbiAgICBsZXQgYnV0dG9ucyA9ICcnO1xuICAgIGxldCBlbGVtZW50Q2xhc3NlcyA9ICcnO1xuICAgIGxldCBiYWNrZ3JvdW5kSW1hZ2UgPSAnJztcbiAgICBsZXQgbWFpbkF0dHJpYnV0ZSA9ICcnO1xuXG4gICAgaWYgKHBhdGgpIHtcbiAgICAgIGJhY2tncm91bmRJbWFnZSA9IGBzdHlsZT1cImJhY2tncm91bmQtaW1hZ2U6IHVybCgke3BhdGh9KVwiYDtcbiAgICB9XG5cbiAgICBpZiAoYXZhdGFyVXJsKSB7XG4gICAgICBiYWNrZ3JvdW5kSW1hZ2UgPSBgc3R5bGU9XCJiYWNrZ3JvdW5kLWltYWdlOiB1cmwoJHthdmF0YXJVcmx9KVwiYDtcbiAgICB9XG5cbiAgICBpZiAobWFpbikge1xuICAgICAgbWFpbkF0dHJpYnV0ZSA9IGBkYXRhLW1haW49XCIke21haW59XCJgO1xuICAgIH1cblxuICAgIGlmIChtYWluICYmICFlbXB0eSkge1xuICAgICAgZWxlbWVudENsYXNzZXMgPSAndmctcGhvdG8gdmctcGhvdG8tLW1haW4nO1xuICAgICAgYnV0dG9ucyA9IGBcbiAgICAgICAgPGJ1dHRvbiBjbGFzcz1cInZnLXBob3RvX19idXR0b24gdmctYnV0dG9uIHZnLWJ1dHRvbi0tcmVkXCIgZGF0YS1hY3Rpb249XCJyZW1vdmUtcGhvdG9cIj7Qo9C00LDQu9C40YLRjDwvYnV0dG9uPlxuICAgICAgYDtcbiAgICB9IGVsc2UgaWYgKG1haW4gJiYgZW1wdHkpIHtcbiAgICAgIGVsZW1lbnRDbGFzc2VzID0gJ3ZnLXBob3RvIHZnLXBob3RvLS1tYWluJztcbiAgICAgIGJ1dHRvbnMgPSBgXG4gICAgICAgIDxidXR0b24gY2xhc3M9XCJ2Zy1waG90b19fYnV0dG9uIHZnLWJ1dHRvblwiIGRhdGEtYWN0aW9uPVwidXBsb2FkLXBob3RvXCI+0JfQsNCz0YDRg9C30LjRgtGMPC9idXR0b24+XG4gICAgICBgO1xuICAgIH0gZWxzZSBpZiAoIW1haW4gJiYgZW1wdHkpIHtcbiAgICAgIGVsZW1lbnRDbGFzc2VzID0gJ3ZnLWdhbGxlcnlfX2l0ZW0gdmctcGhvdG8gdmctcGhvdG8tLXVwbG9hZCc7XG4gICAgICBidXR0b25zID0gYFxuICAgICAgICA8YnV0dG9uIGNsYXNzPVwidmctcGhvdG9fX2J1dHRvbiB2Zy1idXR0b24gdmctYnV0dG9uLS11cGxvYWRcIiBkYXRhLWFjdGlvbj1cInVwbG9hZC1waG90b1wiPiYjNDM7PC9idXR0b24+XG4gICAgICBgO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbGVtZW50Q2xhc3NlcyA9ICd2Zy1nYWxsZXJ5X19pdGVtIHZnLXBob3RvJztcbiAgICAgIGJ1dHRvbnMgPSBgXG4gICAgICAgIDxidXR0b24gY2xhc3M9XCJ2Zy1waG90b19fYnV0dG9uIHZnLWJ1dHRvbiB2Zy1idXR0b24tLWdyZWVuXCIgZGF0YS1hY3Rpb249XCJ1cGRhdGUtcGhvdG9cIj7QktGL0LHRgNCw0YLRjDwvYnV0dG9uPlxuICAgICAgICA8YnV0dG9uIGNsYXNzPVwidmctcGhvdG9fX2J1dHRvbiB2Zy1idXR0b24gdmctYnV0dG9uLS1yZWRcIiBkYXRhLWFjdGlvbj1cInJlbW92ZS1waG90b1wiPtCj0LTQsNC70LjRgtGMPC9idXR0b24+XG4gICAgICBgO1xuICAgIH1cblxuICAgIHJldHVybiBgXG4gICAgICA8ZGl2IGNsYXNzPVwiJHtlbGVtZW50Q2xhc3Nlc31cIlxuICAgICAgICAke2JhY2tncm91bmRJbWFnZX1cbiAgICAgICAgZGF0YS1waG90by1pZD1cIiR7cGhvdG9JZH1cIlxuICAgICAgICAke21haW5BdHRyaWJ1dGV9PlxuICAgICAgICAke2lzQ29udHJvbHNEaXNhYmxlZCA/ICcnIDogYnV0dG9uc31cbiAgICAgICAgPC9kaXY+XG4gICAgICBgO1xuICB9XG5cbiAgLyoqXG4gICAqINCY0L3QuNGG0LjQsNC70LjQt9Cw0YbQuNGPINGB0L7QsdGL0YLQuNC5INC00LvRjyDQutC90L7Qv9C+0Log0LPQsNC70LXRgNC10LguXG4gICAqL1xuICBzdGF0aWMgaW5pdEV2ZW50cygpIHtcbiAgICBjb25zdCB7cm9vdEVsZW1lbnR9ID0gdGhpcztcbiAgICBjb25zdCBidXR0b25zID0gcm9vdEVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnYnV0dG9uJyk7XG5cbiAgICBidXR0b25zLmZvckVhY2goYnV0dG9uID0+IHtcbiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMucm91dGVyW2J1dHRvbi5kYXRhc2V0LmFjdGlvbl0sIGZhbHNlKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDQoNC+0YPRgtC10YAuXG4gICAqIEB0eXBlIHt7XCJyZW1vdmUtcGhvdG9cIjogZnVuY3Rpb24oKik6IHZvaWQsIFwiZmlsZS1pbnB1dC1jaGFuZ2VkXCI6IGZ1bmN0aW9uKCopOiB2b2lkLCBcInVwbG9hZC1waG90b1wiOiBmdW5jdGlvbigqKTogdm9pZCwgXCJ1cGRhdGUtcGhvdG9cIjogZnVuY3Rpb24oKik6IHZvaWR9fVxuICAgKi9cbiAgc3RhdGljIHJvdXRlciA9IHtcbiAgICAvKipcbiAgICAgKiDQl9Cw0LPRgNGD0LfQutCwINGE0L7RgtC+0LPRgNCw0YTQuNC4INGB0L7RgtGA0YPQtNC90LjQutCwLlxuICAgICAqIEBwYXJhbSBlIHtFdmVudH0g0KHQvtCx0YvRgtC40LUuXG4gICAgICovXG4gICAgJ3VwbG9hZC1waG90byc6IChlKSA9PiB7XG4gICAgICBjb25zdCBmaWxlSW5wdXQgPSB0aGlzLnJvb3RFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W3R5cGU9XCJmaWxlXCJdJyk7XG5cbiAgICAgIGZpbGVJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB0aGlzLnJvdXRlclsnZmlsZS1pbnB1dC1jaGFuZ2VkJ10pO1xuICAgICAgZmlsZUlucHV0LmNsaWNrKCk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiDQodC70YPRiNCw0YLQtdC70Ywg0YHQvtCx0YvRgtC40Y8g0LjQt9C80LXQvdC10L3QuNGPINGE0LDQudC70L7QstC+0LPQviDQv9C+0LvRjyDQstCy0L7QtNCwLlxuICAgICAqIEBwYXJhbSBlIHtldmVudH0g0KHQvtCx0YvRgtC40LUuXG4gICAgICovXG4gICAgJ2ZpbGUtaW5wdXQtY2hhbmdlZCc6IChlKSA9PiB7XG4gICAgICBjb25zdCBmaWxlID0gZS50YXJnZXQuZmlsZXNbMF07XG4gICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuXG4gICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcblxuICAgICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5hZGRQaG90byhyZWFkZXIucmVzdWx0KVxuICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgICB0aGlzLmRyYXcoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiByZXNwb25zZSxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJlYWRlci5vbmVycm9yID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmhhbmRsZUVycm9yKHtcbiAgICAgICAgICBtZXNzYWdlOiByZWFkZXIuZXJyb3IsXG4gICAgICAgICAgYmxvY2tpbmdFcnJvck1lc3NhZ2U6IGDQntGI0LjQsdC60LAg0LfQsNCz0YDRg9C30LrQuCDRhNC+0YLQvtCz0YDQsNGE0LjQuCAoLdC40LkpOiAke3JlYWRlci5lcnJvcn1gLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LFxuICAgIC8qKlxuICAgICAqINCX0LDQv9GA0L7RgSDQvdCwINGD0LTQsNC70LXQvdC40LUg0YTQvtGC0L7Qs9GA0LDRhNC40Lgg0YHQvtGC0YDRg9C00L3QuNC60LAuXG4gICAgICogQHBhcmFtIGUge0V2ZW50fSDQodC+0LHRi9GC0LjQtS5cbiAgICAgKi9cbiAgICAncmVtb3ZlLXBob3RvJzogKGUpID0+IHtcbiAgICAgIGNvbnN0IHBob3RvRWxlbWVudCA9IGUudGFyZ2V0LmNsb3Nlc3QoJy52Zy1waG90bycpO1xuICAgICAgY29uc3Qge3Bob3RvSWR9ID0gcGhvdG9FbGVtZW50LmRhdGFzZXQ7XG5cbiAgICAgIGlmICghIXBob3RvSWQpIHtcbiAgICAgICAgdGhpcy5kZWxldGVQaG90bygrcGhvdG9JZClcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgdGhpcy5kcmF3KCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVFcnJvcih7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogcmVzcG9uc2UsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gICAgLyoqXG4gICAgICog0JfQsNC/0YDQvtGBINC90LAg0L7QsdC90L7QstC70LXQvdC40LUg0YTQvtGC0L7Qs9GA0LDRhNC40Lgg0YHQvtGC0YDRg9C00L3QuNC60LAuXG4gICAgICogQHBhcmFtIGUge0V2ZW50fSDQodC+0LHRi9GC0LjQtS5cbiAgICAgKi9cbiAgICAndXBkYXRlLXBob3RvJzogKGUpID0+IHtcbiAgICAgIGNvbnN0IHBob3RvRWxlbWVudCA9IGUudGFyZ2V0LmNsb3Nlc3QoJy52Zy1waG90bycpO1xuICAgICAgY29uc3Qge3Bob3RvSWR9ID0gcGhvdG9FbGVtZW50LmRhdGFzZXQ7XG5cbiAgICAgIGlmICghIXBob3RvSWQpIHtcbiAgICAgICAgdGhpcy51cGRhdGVQaG90bygrcGhvdG9JZClcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgdGhpcy5kcmF3KCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVFcnJvcih7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogcmVzcG9uc2UsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gIH1cbn0iLCIvLyBUaGUgbW9kdWxlIGNhY2hlXG52YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307XG5cbi8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uXG5mdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7XG5cdC8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZVxuXHRpZihfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdKSB7XG5cdFx0cmV0dXJuIF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF0uZXhwb3J0cztcblx0fVxuXHQvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKVxuXHR2YXIgbW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXSA9IHtcblx0XHQvLyBubyBtb2R1bGUuaWQgbmVlZGVkXG5cdFx0Ly8gbm8gbW9kdWxlLmxvYWRlZCBuZWVkZWRcblx0XHRleHBvcnRzOiB7fVxuXHR9O1xuXG5cdC8vIEV4ZWN1dGUgdGhlIG1vZHVsZSBmdW5jdGlvblxuXHRfX3dlYnBhY2tfbW9kdWxlc19fW21vZHVsZUlkXShtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTtcblxuXHQvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZVxuXHRyZXR1cm4gbW9kdWxlLmV4cG9ydHM7XG59XG5cbiIsIi8vIG1vZHVsZSBleHBvcnRzIG11c3QgYmUgcmV0dXJuZWQgZnJvbSBydW50aW1lIHNvIGVudHJ5IGlubGluaW5nIGlzIGRpc2FibGVkXG4vLyBzdGFydHVwXG4vLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHNcbnJldHVybiBfX3dlYnBhY2tfcmVxdWlyZV9fKDk0Nik7XG4iLCIvLyBkZWZpbmUgZ2V0dGVyIGZ1bmN0aW9ucyBmb3IgaGFybW9ueSBleHBvcnRzXG5fX3dlYnBhY2tfcmVxdWlyZV9fLmQgPSBmdW5jdGlvbihleHBvcnRzLCBkZWZpbml0aW9uKSB7XG5cdGZvcih2YXIga2V5IGluIGRlZmluaXRpb24pIHtcblx0XHRpZihfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZGVmaW5pdGlvbiwga2V5KSAmJiAhX193ZWJwYWNrX3JlcXVpcmVfXy5vKGV4cG9ydHMsIGtleSkpIHtcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBrZXksIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBkZWZpbml0aW9uW2tleV0gfSk7XG5cdFx0fVxuXHR9XG59OyIsIl9fd2VicGFja19yZXF1aXJlX18ubyA9IGZ1bmN0aW9uKG9iaiwgcHJvcCkgeyByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7IH0iXSwic291cmNlUm9vdCI6IiJ9